<!-- Delegating build script, used by cruisecontrol to build helloworld.
     Note that the basedir is set to the checked out project -->

<project name="build-kieler" basedir="checkout/kieler" default="metrics">

<!--	<import file="panopticode/panopticode-imports.xml" /> -->

	<property name="version" value="0.0.1" />
	<property name="project.name" value="Kiel Integrated Environment for Layout for the Eclipse RichClientPlatform" />
	
	<property name="eclipse" value="/home/java/eclipse_3.4" /> 
	
	<path id="classpath">
		<fileset id="javaLibFiles" dir="/home/java/jdk1.6.0_03/">
			<include name="**/**/*.jar"/>
			<include name="**/*.jar"/>
			<include name="*.jar"/>
		</fileset>
		<fileset id="eclipseLibFiles" dir="/home/java/eclipse_3.4/plugins/">
			<include name="**/**/*.jar"/>
			<include name="**/*.jar"/>
			<include name="*.jar"/>
		</fileset>
	</path>
	

	<echo message="starting..."/>
	
	<!-- specify plugins to be checked out -->
	<property name="plugin1" value="http://rtsys/svn/kieler/trunk/common/examples/editors/de.cau.cs.kieler.ssm.emf"/>
	<property name="plugin2" value="http://rtsys/svn/kieler/trunk/common/examples/editors/de.cau.cs.kieler.ssm.feature"/>
	<property name="plugin3" value="http://rtsys/svn/kieler/trunk/common/examples/editors/de.cau.cs.kieler.ssm.emf.edit"/>
	<property name="plugin4" value="http://rtsys/svn/kieler/trunk/common/examples/editors/de.cau.cs.kieler.ssm.gmf.diagram"/>

	<property name="svnuser"   value="tomcat5" />
	<property name="svnpasswd" value="edcvgz"  />
	<target name="checkout">
		<echo message="checking out for the first time"/>
		<exec executable="svn">
			<arg line="co --username ${svnuser} --password ${svnpasswd} ${plugin1}" />
		</exec>
		<exec executable="svn">
			<arg line="co --username ${svnuser} --password ${svnpasswd} ${plugin2}" />
		</exec>
		<exec executable="svn">
			<arg line="co --username ${svnuser} --password ${svnpasswd} ${plugin3}" />
		</exec>
		<exec executable="svn">
			<arg line="co --username ${svnuser} --password ${svnpasswd} ${plugin4}" />
		</exec>
	</target>
	
	<!-- Get the latest from SVN -->
	<target name="update" depends="checkout">
		<echo message="updating"/>
		<!-- problem: path is missing... -->
		<exec executable="svn">
			<arg line="up --username tomcat5 --password edcvgz"/>
		</exec>
		<mkdir dir="buildDirectory/features"/>
		<mkdir dir="buildDirectory/plugins"/>
		<copy overwrite="false" todir="buildDirectory/features">
			<fileset dir=".">
		        <include name="*.feature/**"/>
				<exclude name="buildDirectory/**"/>
			</fileset>
		</copy>
		<copy overwrite="false" todir="buildDirectory/plugins">
			<fileset dir=".">
				<exclude name="buildDirectory/**"/>
				<exclude name="*.feature/**"/>
			</fileset>
		</copy>
	</target>

	
	<!-- ================================= 
          target: updatesite              
         ================================= -->
	<property name="siteproject" value="de.cau.cs.kieler.updatesite"/>
	<property name="siteprojecturl" value="http://rtsys/svn/kieler/trunk/cruisecontrol/"/>
	<property name="sitepath" value="/home/haf/public_html/kielerupdatesite"/>
	<target 
		name="updatesite" 
		depends="compile" 
		description="Create proper Update Site for the plugins.">
		<!-- checkout updatesite project -->
		<exec executable="svn">
			<arg line="co --username tomcat5 --password edcvgz ${siteprojecturl}${siteproject}"/>
		</exec> 
		<!-- unpack generated jars to update site project
		     set archivePrefix already in the build-properties to the updatesite project name -->
		<unzip dest=".">
			<fileset dir="buildDirectory/build">
						<include name="*.zip"/>	
			</fileset>
		</unzip>
		<!-- move complete update site to target dir that is accessible via web -->
		<move todir="${sitepath}" >
			<fileset dir="${siteproject}"/>
		</move>
    </target>
	
	<target name="clean">
		<delete dir="target" />
	</target>

	<!-- ================================= 
          target: compile              
         ================================= -->
	<property name="arg1" value="-application org.eclipse.ant.core.antRunner" />
	<property name="arg2" value="-DbaseLocation=${eclipse}" />
	<property name="arg3" value="-buildfile ${eclipse}/plugins/org.eclipse.pde.build_3.4.0.v20080604/scripts/build.xml" />
	<property name="arg4" value="-DbuildDirectory=${basedir}/buildDirectory"/>
	<property name="arg5" value="-Dbuilder=${basedir}/buildDirectory/features/de.cau.cs.kieler.ssm.feature"/>
	<target 
		name="compile" 
		depends="update" 
		description="Do the actual compile step. This is done by the Eclipse
        internal AntRunner, because it includes the support of special
        targets required for eclipse features.">
		<java fork="true" 
			  failonerror="true"
			  classpath="${eclipse}/plugins/org.eclipse.equinox.launcher_1.0.100.v20080509-1800.jar"
			  jar="${eclipse}/plugins/org.eclipse.equinox.launcher_1.0.100.v20080509-1800.jar"
			  args="${arg1} ${arg2} ${arg3} ${arg4} ${arg5}">
		</java>
		
	</target>

	<target name="metrics" depends="clean">

		<panopticode classDir="${basedir}/@dot"
			panopticodeDir="/home/local/cruisecontrol/ccworkingdir/panopticode" 
			projectDir="${basedir}"
			projectName="${project.name}"
			projectVersion="${version}"
			outputDir="${basedir}/target"
			srcDir="${basedir}/src" />
	</target>

	<target name="unit-test">
		<!--
		<javac debug="true" destdir="target/classes">
			<src path="unittest/src"/>
			<classpath>
				<fileset dir="prod" includes="lib/**/*.jar" />
				<fileset dir="unittest" includes="lib/**/*.jar" />

				<pathelement location="target/classes" />
			</classpath>
			<compilerarg value="-Xlint:unchecked" />
		</javac>

		<mkdir dir="target/rawmetrics/xml/junit" />
		<path id="unittest.path">
			<fileset dir="prod" includes="lib/**/*.jar" />
			<fileset dir="unittest" includes="lib/**/*.jar" />
			<pathelement location="target/classes" />
		</path>
		<panopticode-junit unitTestClasspathId="unittest.path"
			outputDir="target">
			<batchtest todir="target/rawmetrics/xml/junit">
				<fileset dir="target/classes" includes="**/*Test.class" />
			</batchtest>
		</panopticode-junit>
		-->
	</target>

	<target name="rasterize-all-reports"
		depends="rasterize-png-reports,rasterize-jpeg-reports,rasterize-tiff-reports"/>

	<target name="rasterize-png-reports">
		<delete dir="target/reports/png" />
		<mkdir dir="target/reports/png" />

		<svg-to-png srcFile="target/reports/svg/complexity-treemap.svg"
			destFile="target/reports/png/complexity-treemap.png" />
		<svg-to-png srcFile="target/reports/svg/coverage-treemap.svg"
			destFile="target/reports/png/coverage-treemap.png" />

		<svg-to-png srcFile="target/reports/svg/complexity-treemap.svg"
			destFile="target/reports/png/complexity-treemap-thumb.png"
			width="128"
			height="96"/>
		<svg-to-png srcFile="target/reports/svg/coverage-treemap.svg"
			destFile="target/reports/png/coverage-treemap-thumb.png"
			width="128"
			height="96"/>
	</target>

	<target name="rasterize-jpeg-reports">
		<delete dir="target/reports/jpeg" />
		<mkdir dir="target/reports/jpeg" />

		<svg-to-jpeg srcFile="target/reports/svg/complexity-treemap.svg"
			destFile="target/reports/jpeg/complexity-treemap.jpg" />
		<svg-to-jpeg srcFile="target/reports/svg/coverage-treemap.svg"
			destFile="target/reports/jpeg/coverage-treemap.jpg" />

		<svg-to-jpeg srcFile="target/reports/svg/complexity-treemap.svg"
			destFile="target/reports/jpeg/complexity-treemap-thumb.jpg"
			width="128"
			height="96"/>
		<svg-to-jpeg srcFile="target/reports/svg/coverage-treemap.svg"
			destFile="target/reports/jpeg/coverage-treemap-thumb.jpg"
			width="128"
			height="96"/>
	</target>

	<target name="rasterize-tiff-reports">
		<delete dir="target/reports/tiff" />
		<mkdir dir="target/reports/tiff" />

		<svg-to-tiff srcFile="target/reports/svg/complexity-treemap.svg"
			     destFile="target/reports/tiff/complexity-treemap.tif" />
		<svg-to-tiff srcFile="target/reports/svg/coverage-treemap.svg"
			     destFile="target/reports/tiff/coverage-treemap.tif" />

		<svg-to-tiff srcFile="target/reports/svg/complexity-treemap.svg"
			     destFile="target/reports/tiff/complexity-treemap-thumb.tif"
			     width="128"
			     height="96"/>
		<svg-to-tiff srcFile="target/reports/svg/coverage-treemap.svg"
			     destFile="target/reports/tiff/coverage-treemap-thumb.tif"
			     width="128"
			     height="96"/>
	</target>

	<target name="index">
		<copy file="/home/local/cruisecontrol/ccworkingdir/html/index.htm" todir="target">
			<filterset>
      			<filter token="project.name" value="${project.name}"/>
    		</filterset>
		</copy>
	</target>

	<target name="clean.sources">
        <!-- clean up src.zip -->
        <delete dir="target/src" />
        <mkdir dir="target/src" /> 
		<copy todir="target/src">
			<fileset dir="${basedir}">
				<include name="*.zip"/>
			</fileset>
		</copy>
        <delete>
                <fileset dir="${basedir}">
                        <include name="*.zip"/>
                </fileset>
        </delete>

        <!-- clean up package.jar -->
        <delete dir="target/package" />
        <mkdir dir="target/package" />
        <copy todir="target/package">
                <fileset dir="${basedir}">
                        <include name="*.jar"/>
                </fileset>
        </copy>
        <delete>
                <fileset dir="${basedir}">
                        <include name="*.jar"/>
                </fileset>
        </delete>

        <!-- clean up javadocs -->
        <delete dir="target/docs/api" />
        <mkdir dir="target/docs/api" />
	</target>
		
        <!-- generate javadoc -->
    <target name="javadoc" depends="clean.sources">
		<javadoc sourcepath="src"
                destdir="target/docs/api"
                classpathref="classpath"
                windowtitle="UML Modeling 2007"
                access="private"
                author="true"
                use="true"
                version="true"
                source="1.6">
                <fileset dir="src">
                        <include name="**.java"/>
                </fileset>
                <packageset dir="src" defaultexcludes="yes">
                        <include name="**"/>
                </packageset>
                <tag name="todo" scope="all" description="To do:"/>
                <tag name="Override" scope="all" description="Override:"/>
                <doctitle>
                        <![CDATA[<h1>UML Modeling 2007</h1><h2>Practical Laboratory Course at the winter term 2007/08</h2><h3>Test Project <i>HelloWorld</i></h3>]]>
                </doctitle>
                <bottom>
                        <![CDATA[<i>Copyright &#169; 2008 - Real-Time and Embedded Systems Group at Christian-Albrechts-University of Kiel - All Rights Reserved.</i>]]>
                </bottom>
        </javadoc>
	</target>

</project>
